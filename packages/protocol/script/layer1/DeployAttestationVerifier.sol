// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "../../test/shared/DeployCapability.sol";
import "../../contracts/layer1/automata-attestation/AttestationVerifier.sol";
import "../../contracts/layer1/automata-attestation/interfaces/IAttestationVerifier.sol";

contract DeployAttestationVerifier is DeployCapability {
    address public automataDcapAttestation = vm.envAddress("AUTOMATA_DCAP_ATTESTATION");
    bool public checkPCR10 = vm.envOr("CHECK_PRC10", true);
    bool public simulateVerify = vm.envOr("SIMULATE_VERIFY", false);

    function run() external {
        require(automataDcapAttestation != address(0), "invalid automata DCAP attestation address");

        vm.startBroadcast();

        // Deploy Attestation Verifier
        AttestationVerifier attesatationVerifier = new AttestationVerifier();

        address proxy = deployProxy({
            name: "attestation_verifier",
            impl: address(attesatationVerifier),
            data: abi.encodeCall(AttestationVerifier.init, (msg.sender, automataDcapAttestation, true))
        });

        vm.stopBroadcast();

        if (simulateVerify) {
            IAttestationVerifier verifier = IAttestationVerifier(proxy);
            vm.startBroadcast();
            if (checkPCR10) {
                verifier.setImagePcr10(0x0000000000000000000000005dc76075bce6c1c1c059ffe7a6770557a35ded16, true);
            }
            vm.stopBroadcast();
            bytes memory report = hex"040002008100000000000000939a7233f79c4ca9940a0db3957f0607000000000000000000000000000000000000000005010700000000000000000000000000bf70f5c1c2c1610bf2ddad348a88ebf6a550256e949e52122c743dc97cde50ccafad2fc5927d150f307fba3b8ca2187200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000e7000600000000005d56080eb9ef8ce0bbaf6bdcdadeeb06e7c5b0a4d1ec16be868a85a953babe0c5e54d01c8e050a54fe1ca078372530d200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000038dfddac34c407cae549ce6c7dced2c6a7e3662530d083476ec9be2315bc5ee47fe42ecffbc876fbfe7fc547ff3c448100e7008e385f9bc0e8cedb1155c586f9e7293371fe226d19f4747454f37fc48691c3ba196586c9d3ac41f06b7e4b99f20835e9c6eaa725436d06c73977262b6cfd244a472b31de476b6ed705f28441ce37a26146b49635feb024b4d542715dde0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000380b32488ae76fa9dfd89e0aac1b1893c3721fb1bfc0d755d01c62294e255d6acb100000c9a9b8859a21bc2eb73e1a8fcbf32e0ac064a0fd166debcfce7492adfb87bb74e4eb7015bfe0d1516c3a23d36b8736db12c55496ca9cb47df2fa31b70903098eed0259c3e22f09a9377a6c9608f7e6f42cbc97225a26863b0f9b2d5a58f8c9929e50f35f2282586560616d7d893c14fe14bdf0b00650b7414f63249b64ba0bc20600451000000707ff1b03ff0006000000000000000000000000000000000000000000000000000000000000000000000000000000001500000000000000e700000000000000e5a3a7b5d830c2953b98534c6c59a3a34fdc34e933f7f5898f0a85cf08846bca0000000000000000000000000000000000000000000000000000000000000000dc9e2a7c6f948f17474e34a7fc43ed030f7c1563f1babddf6340c82e0e54a8c500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a77f159310132d91e3a1fa16a78f6cfee7239f0101756bbf07bc9d6a5fa2f48300000000000000000000000000000000000000000000000000000000000000008ecced63d9a141d23a61c3b186ac5e4849f5dc6a8236cae0786e7ba63b8e799e47797be9e0ae96a38cebbb8f48a8d05244f677cc7df02808af04a830113baa292000000000000000000000000000000000000000000000000000000000000000000005005d0e00002d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d49494538444343424a61674177494241674955634e78736d372f76357342724e2b2b37644c62446941776232696777436759494b6f5a497a6a3045417749770a634445694d434147413155454177775a535735305a577767553064594946424453794251624746305a6d397962534244515445614d42674741315545436777520a535735305a577767513239796347397959585270623234784644415342674e564241634d43314e68626e526849454e7359584a684d51737743515944565151490a44414a445154454c4d416b474131554542684d4356564d774868634e4d6a51784d4441324d44677a4e7a55775768634e4d7a45784d4441324d44677a4e7a55770a576a42774d534977494159445651514444426c4a626e526c624342545231676755454e4c49454e6c636e52705a6d6c6a5958526c4d526f77474159445651514b0a4442464a626e526c6243424462334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e560a4241674d416b4e424d517377435159445651514745774a56557a425a4d424d4742797147534d34394167454743437147534d34394177454841304941424554510a773361583662454568357773524c2b34757954734a52522f775a6d50627050554a76745a344734766f636e3237414d7672484376394a3568346150767752306d0a35344e365262306b4d534d587a4d67396f71616a67674d4d4d4949444344416642674e5648534d4547444157674253566231334e765276683655424a796454300a4d383442567776655644427242674e56485238455a4442694d47436758714263686c706f64485277637a6f764c32467761533530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c334e6e6543396a5a584a3061575a7059324630615739754c3359304c33426a61324e796244396a595431770a624746305a6d397962535a6c626d4e765a476c755a7a316b5a584977485159445652304f42425945464c2b3049626658585858786e725969456c514d78615a390a475359494d41344741315564447745422f775145417749477744414d42674e5648524d4241663845416a41414d4949434f51594a4b6f5a496876684e415130420a424949434b6a4343416959774867594b4b6f5a496876684e4151304241515151364d61565764716f4f6c334a615436516c684c5a6744434341574d47436971470a534962345451454e41514977676746544d42414743797147534962345451454e41514942416745484d42414743797147534962345451454e41514943416745480a4d42414743797147534962345451454e41514944416745434d42414743797147534962345451454e41514945416745434d42414743797147534962345451454e0a41514946416745444d42414743797147534962345451454e41514947416745424d42414743797147534962345451454e41514948416745414d424147437971470a534962345451454e41514949416745444d42414743797147534962345451454e4151494a416745414d42414743797147534962345451454e4151494b416745410a4d42414743797147534962345451454e4151494c416745414d42414743797147534962345451454e4151494d416745414d42414743797147534962345451454e0a4151494e416745414d42414743797147534962345451454e4151494f416745414d42414743797147534962345451454e41514950416745414d424147437971470a534962345451454e41514951416745414d42414743797147534962345451454e415149524167454c4d42384743797147534962345451454e41514953424241480a42774943417745414177414141414141414141414d42414743697147534962345451454e41514d45416741414d42514743697147534962345451454e415151450a42674341627755414144415042676f71686b69472b45304244514546436745424d42344743697147534962345451454e415159454542447a73353959556f76390a6354387168356b41632f34775241594b4b6f5a496876684e41513042427a41324d42414743797147534962345451454e415163424151482f4d424147437971470a534962345451454e41516343415145414d42414743797147534962345451454e415163444151482f4d416f4743437147534d343942414d43413067414d4555430a494238467354384c782b687251424468505a6446784d47707a363764344348436a6178743578534a4443535a416945416777577953464361456330466e4776780a65544f6146796875484964426737696951374f42465162312b4c413d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436c6a4343416a32674177494241674956414a567658633239472b487051456e4a3150517a7a674658433935554d416f4743437147534d343942414d430a4d476778476a415942674e5642414d4d45556c756447567349464e48574342536232393049454e424d526f77474159445651514b4442464a626e526c624342440a62334a7762334a6864476c76626a45554d424947413155454277774c553246756447456751327868636d4578437a414a42674e564241674d416b4e424d5173770a435159445651514745774a56557a4165467730784f4441314d6a45784d4455774d5442614677307a4d7a41314d6a45784d4455774d5442614d484178496a41670a42674e5642414d4d47556c756447567349464e4857434251513073675547786864475a76636d306751304578476a415942674e5642416f4d45556c75644756730a49454e76636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b474131554543417743513045780a437a414a42674e5642415954416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a304441516344516741454e53422f377432316c58534f0a3243757a7078773734654a423732457944476757357258437478327456544c7136684b6b367a2b5569525a436e71523770734f766771466553786c6d546c4a6c0a65546d693257597a33714f42757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f536347724442530a42674e5648523845537a424a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b633256790a646d6c6a5a584d75615735305a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e5648513445466751556c5739640a7a62306234656c4153636e553944504f4156634c336c517744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159420a4166384341514177436759494b6f5a497a6a30454177494452774177524149675873566b6930772b6936565947573355462f32327561586530594a446a3155650a6e412b546a44316169356343494359623153416d4435786b66545670766f34556f79695359787244574c6d5552344349394e4b7966504e2b0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a2d2d2d2d2d424547494e2043455254494649434154452d2d2d2d2d0a4d4949436a7a4343416a53674177494241674955496d554d316c71644e496e7a6737535655723951477a6b6e42717777436759494b6f5a497a6a3045417749770a614445614d4267474131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e760a636e4276636d4630615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a0a42674e5642415954416c56544d423458445445344d4455794d5445774e4455784d466f58445451354d54497a4d54497a4e546b314f566f77614445614d4267470a4131554541777752535735305a5777675530645949464a766233516751304578476a415942674e5642416f4d45556c756447567349454e76636e4276636d46300a615739754d5251774567594456515148444174545957353059534244624746795954454c4d416b47413155454341774351304578437a414a42674e56424159540a416c56544d466b77457759484b6f5a497a6a3043415159494b6f5a497a6a3044415163445167414543366e45774d4449595a4f6a2f69505773437a61454b69370a314f694f534c52466857476a626e42564a66566e6b59347533496a6b4459594c304d784f346d717379596a6c42616c54565978465032734a424b357a6c4b4f420a757a43427544416642674e5648534d4547444157674251695a517a575770303069664f44744a5653763141624f5363477244425342674e5648523845537a424a0a4d45656752614244686b466f64485277637a6f764c324e6c636e52705a6d6c6a5958526c63793530636e567a6447566b63325679646d6c6a5a584d75615735300a5a577775593239744c306c756447567355306459556d397664454e424c6d526c636a416442674e564851344546675155496d554d316c71644e496e7a673753560a55723951477a6b6e4271777744675944565230504151482f42415144416745474d42494741315564457745422f7751494d4159424166384341514577436759490a4b6f5a497a6a3045417749445351417752674968414f572f35516b522b533943695344634e6f6f774c7550524c735747662f59693747535839344267775477670a41694541344a306c72486f4d732b586f356f2f7358364f39515778485241765a55474f6452513763767152586171493d0a2d2d2d2d2d454e442043455254494649434154452d2d2d2d2d0a";
            bytes32 userData = 0x878a004780087a4a1179f898dac63b82621cb1095310ec985ca30e1ea4db3982;
            bytes memory ext = hex"00000000000000000000000000000000000000000000000000000000000000200000000000000000000000005dc76075bce6c1c1c059ffe7a6770557a35ded160000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000091ff54434780180022000be3ab87ae350cb7fa7a01a2ee05264add05d66afb2384a460ea5f005feb7015bd00200000000000000000000000000000000000000000000000000000000000000000000000001d7d7ae1000000110000000001201605110016280000000001000403000400002024fa4e95db5220aa118c0fc83ab5ecbee65f5cf31063809bce75e7287284e5a300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000480018000b00202d6f2f05d08ba3c881d081e17a9d6756ee3388ea7d27bf0ef759314ce32bab370020f2fcac4ffd55e99b391ee8d1f72ff6587ef0600dcd92026f1b3c7c343c8549020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
            verifier.verifyAttestation(report, userData, ext);
        }
    }
}